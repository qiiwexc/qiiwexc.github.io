name: Nightly dependency update

permissions:
  contents: read

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: windows-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      actions: write
    steps:
      - name: Check out repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check for dependency updates
        id: update
        shell: powershell
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          try {
              .\tools\build.ps1 -Update -CI
          } catch {
              Write-Host "::warning::Build script error: $_"
          }

          $diff = git diff --name-only --ignore-cr-at-eol resources/dependencies.json

          if ($diff) {
              . .\tools\common\types.ps1
              . .\tools\build\Compare-Dependencies.ps1

              [Dependency[]]$OldDeps = git show HEAD:resources/dependencies.json | ConvertFrom-Json
              [Dependency[]]$NewDeps = Get-Content resources/dependencies.json -Raw | ConvertFrom-Json
              $UrlsTemplate = Get-Content resources/urls.json -Raw | ConvertFrom-Json

              $Result = Compare-Dependencies $OldDeps $NewDeps $UrlsTemplate

              "has_updates=true" >> $env:GITHUB_OUTPUT

              if ($env:CHANGELOG_URLS) {
                  "changelog_urls<<EOF" >> $env:GITHUB_OUTPUT
                  $env:CHANGELOG_URLS >> $env:GITHUB_OUTPUT
                  "EOF" >> $env:GITHUB_OUTPUT
              }
          } else {
              "has_updates=false" >> $env:GITHUB_OUTPUT
          }

      - name: Create pull request
        if: steps.update.outputs.has_updates == 'true'
        id: create-pr
        shell: powershell
        env:
          GH_TOKEN: ${{ github.token }}
          CHANGELOG_URLS: ${{ steps.update.outputs.changelog_urls }}
        run: |
          $now = Get-Date
          $branch = "chore/update-dependencies-$($now.ToString('yyyy-MM-dd'))"

          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          git checkout -b $branch
          git add resources/dependencies.json
          git commit -m 'Update dependencies'
          git push origin $branch --force

          $body = ''
          if ($env:CHANGELOG_URLS) {
              $body = ($env:CHANGELOG_URLS -split "`n" | ForEach-Object { $_.Trim() } | Where-Object { $_ } | ForEach-Object { "- $_" }) -join "`n"
          }

          $title = "Update dependencies ($($now.ToString('yyyy.MM.dd')))"
          $existingPr = gh pr list --head $branch --json number --jq 'if length > 0 then .[0].number else empty end'
          if (-not $existingPr) {
              gh pr create --title $title --body $body --reviewer '${{ github.repository_owner }}'
          } else {
              if ($body) {
                  gh pr edit $existingPr --title $title --body $body
              } else {
                  gh pr edit $existingPr --title $title
              }
          }

          "branch=$branch" >> $env:GITHUB_OUTPUT

      - name: Trigger CI on PR branch
        if: steps.update.outputs.has_updates == 'true'
        shell: powershell
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run ci.yml --repo "${{ github.repository }}" --ref "${{ steps.create-pr.outputs.branch }}"
