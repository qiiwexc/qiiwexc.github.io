name: Nightly dependency update

permissions:
  contents: read

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check out repository
        uses: actions/checkout@v6.0.2

      - name: Set up GitHub token for API access
        shell: pwsh
        run: |
          "GITHUB_TOKEN=$env:GH_TOKEN" | Out-File -FilePath .env -Encoding utf8 -NoNewline
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check for dependency updates
        id: update
        shell: pwsh
        run: |
          try {
              .\tools\build.ps1 -Update
          } catch {
              Write-Host "::warning::Build script error: $_"
          }

          git diff --quiet --ignore-cr-at-eol resources/dependencies.json

          if ($LASTEXITCODE -ne 0) {
              . .\tools\common\types.ps1
              . .\tools\build\Compare-Dependencies.ps1

              [Dependency[]]$OldDeps = git show HEAD:resources/dependencies.json | ConvertFrom-Json
              [Dependency[]]$NewDeps = Get-Content resources/dependencies.json -Raw | ConvertFrom-Json
              $UrlsTemplate = Get-Content resources/urls.json -Raw | ConvertFrom-Json

              $Result = Compare-Dependencies $OldDeps $NewDeps $UrlsTemplate

              "has_updates=true" >> $env:GITHUB_OUTPUT
              "has_release_update=$($Result.HasReleaseUpdate)" >> $env:GITHUB_OUTPUT

              if ($env:CHANGELOG_URLS) {
                  "changelog_urls<<EOF" >> $env:GITHUB_OUTPUT
                  $env:CHANGELOG_URLS >> $env:GITHUB_OUTPUT
                  "EOF" >> $env:GITHUB_OUTPUT
              }
          } else {
              "has_updates=false" >> $env:GITHUB_OUTPUT
          }

      - name: Annotate with changelog URLs
        if: steps.update.outputs.has_updates == 'true'
        shell: pwsh
        env:
          CHANGELOG_URLS: ${{ steps.update.outputs.changelog_urls }}
        run: |
          foreach ($line in ($env:CHANGELOG_URLS -split "`n")) {
              $trimmed = $line.Trim()
              if ($trimmed) {
                  Write-Host "::notice title=Changelog::$trimmed"
              }
          }

      - name: Create pull request
        if: steps.update.outputs.has_updates == 'true'
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $branch = 'update-dependencies'

          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          git checkout -b $branch
          git add resources/dependencies.json
          git commit -m 'Update dependencies'
          git push origin $branch --force

          $existingPr = gh pr list --head $branch --json number --jq '.[0].number'
          if (-not $existingPr) {
              gh pr create --title 'Update dependencies' --body '' --reviewer '${{ github.repository_owner }}'
          }
