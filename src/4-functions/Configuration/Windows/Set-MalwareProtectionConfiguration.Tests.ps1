BeforeAll {
    . $PSCommandPath.Replace('.Tests.ps1', '.ps1')

    . '.\src\4-functions\App lifecycle\Logger.ps1'

    Set-Variable -Option Constant TestException ([String]'TEST_EXCEPTION')
}

Describe 'Set-MalwareProtectionConfiguration' {
    BeforeEach {
        Mock Set-MpPreference {}
        Mock Out-Success {}
        Mock Out-Failure {}
    }

    It 'Should apply Windows security configuration' {
        Set-MalwareProtectionConfiguration

        Should -Invoke Set-MpPreference -Exactly 29
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableBlockAtFirstSeen -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableCatchupQuickScan -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableEmailScanning -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableRemovableDriveScanning -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableRestorePoint -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableScanningMappedNetworkDrivesForFullScan -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableScanningNetworkFiles -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $EnableFileHashComputation -eq $True }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $EnableNetworkProtection -eq 'Enabled' }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $PUAProtection -eq 'Enabled' }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $AllowSwitchToAsyncInspection -eq $True }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableArchiveScanning -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableBehaviorMonitoring -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableDnsOverTcpParsing -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableDnsParsing -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableFtpParsing -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableHttpParsing -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableInboundConnectionFiltering -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableIntrusionPreventionSystem -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableIOAVProtection -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableRdpParsing -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableRealtimeMonitoring -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableScriptScanning -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableSmtpParsing -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableSshParsing -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $DisableTlsParsing -eq $False }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $MeteredConnectionUpdates -eq $True }
        Should -Invoke Set-MpPreference -Exactly 1 -ParameterFilter { $BruteForceProtectionLocalNetworkBlocking -eq $True }
        Should -Invoke Out-Success -Exactly 1
        Should -Invoke Out-Failure -Exactly 0
    }

    It 'Should handle Set-MpPreference failure' {
        Mock Set-MpPreference { throw $TestException }

        Set-MalwareProtectionConfiguration

        Should -Invoke Set-MpPreference -Exactly 1
        Should -Invoke Out-Success -Exactly 0
        Should -Invoke Out-Failure -Exactly 1
    }
}
